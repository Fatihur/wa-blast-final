<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Matching - WA Blast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fab fa-whatsapp me-2"></i>
                WA Blast - File Matching
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>
                    Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="fileMatchingTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
                    <i class="fas fa-folder me-2"></i>
                    Documents Manager
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="matching-tab" data-bs-toggle="tab" data-bs-target="#matching" type="button" role="tab">
                    <i class="fas fa-link me-2"></i>
                    File Matching
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="blast-files-tab" data-bs-toggle="tab" data-bs-target="#blast-files" type="button" role="tab">
                    <i class="fas fa-paper-plane me-2"></i>
                    Blast with Files
                </button>
            </li>
        </ul>

        <div class="tab-content" id="fileMatchingTabsContent">
            <!-- Documents Manager Tab -->
            <div class="tab-pane fade show active" id="documents" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Documents Folder Management</h5>
                    </div>
                    <div class="card-body">
                        <!-- Upload Section -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Upload Documents</h6>
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="documentsInput" multiple accept="*/*">
                                    <div class="form-text">Select multiple files to upload to documents folder</div>
                                </div>
                                <button class="btn btn-primary" onclick="uploadDocuments()">
                                    <i class="fas fa-upload me-2"></i>
                                    Upload Files
                                </button>
                                <a href="/api/file-matching/template" class="btn btn-outline-secondary ms-2">
                                    <i class="fas fa-download me-2"></i>
                                    Download Template
                                </a>
                            </div>
                            <div class="col-md-6">
                                <h6>Statistics</h6>
                                <div id="documentsStats">
                                    <p class="text-muted">Loading statistics...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Documents List -->
                        <div id="documentsList">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Documents in Folder</h6>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="selectAllDocuments()" id="selectAllBtn">
                                        <i class="fas fa-check-square me-1"></i>
                                        Select All
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="bulkDeleteSelected()" id="bulkDeleteBtn" disabled>
                                        <i class="fas fa-trash me-1"></i>
                                        Delete Selected
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearAllDocuments()">
                                        <i class="fas fa-trash-alt me-1"></i>
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th width="40">
                                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                            </th>
                                            <th>File Name</th>
                                            <th>Type</th>
                                            <th>Size</th>
                                            <th>Last Modified</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="documentsTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                Loading documents...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Matching Tab -->
            <div class="tab-pane fade" id="matching" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">File Matching Preview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="previewMatching()">
                                    <i class="fas fa-search me-2"></i>
                                    Preview Matching
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="refreshDocuments()">
                                    <i class="fas fa-sync me-2"></i>
                                    Refresh
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="matchingStats" class="text-end">
                                    <!-- Matching statistics will be displayed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Search Box -->
                        <div class="row mb-3" id="contactSearchRow" style="display: none;">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="contactSearchInput"
                                           placeholder="Search contacts by name, number, email, or company..."
                                           onkeyup="searchContacts()" autocomplete="off">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearContactSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span id="searchResultsCount" class="text-muted me-3"></span>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="searchInFilesOnly" onchange="searchContacts()">
                                        <label class="form-check-label" for="searchInFilesOnly">
                                            Search in matched files only
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="matchingResults">
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i>
                                Click "Preview Matching" to see how contacts will be matched with files
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blast with Files Tab -->
            <div class="tab-pane fade" id="blast-files" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Send Blast with File Matching</h5>
                    </div>
                    <div class="card-body">
                        <div id="blastFilesContent">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Please ensure contacts are imported and files are uploaded before sending blast messages.
                            </div>

                            <!-- Template Selector -->
                            <div class="mb-3">
                                <label for="templateSelector" class="form-label">Quick Templates</label>
                                <div class="row">
                                    <div class="col-md-8">
                                        <select class="form-select" id="templateSelector" onchange="loadTemplate()">
                                            <option value="">Select a template...</option>
                                            <option value="simple">Simple Document Delivery</option>
                                            <option value="formal">Formal Business Document</option>
                                            <option value="marketing">Marketing with File</option>
                                            <option value="notification">Document Ready Notification</option>
                                            <option value="invoice">Invoice/Receipt Delivery</option>
                                            <option value="certificate">Certificate Delivery</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-outline-info me-2" onclick="previewTemplates()" data-bs-toggle="modal" data-bs-target="#templatePreviewModal">
                                            <i class="fas fa-eye me-1"></i>
                                            Preview Templates
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="clearTemplate()">
                                            <i class="fas fa-eraser me-1"></i>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Blast Form with Rich Text Editor -->
                            <form id="blastFilesForm" style="display: block !important;">
                                <div class="mb-3">
                                    <label for="blastFilesMessage" class="form-label">Message Template</label>

                                    <!-- Rich Text Toolbar for File Matching -->
                                    <div class="btn-toolbar mb-2" role="toolbar">
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatFileText('bold')" title="Bold">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatFileText('italic')" title="Italic">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatFileText('strikethrough')" title="Strikethrough">
                                                <i class="fas fa-strikethrough"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatFileText('monospace')" title="Monospace">
                                                <i class="fas fa-code"></i>
                                            </button>
                                        </div>
                                        <div class="btn-group me-2" role="group" id="standardFileVariables">
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="insertFileVariable('name')" title="Insert Name">
                                                {{name}}
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="insertFileVariable('number')" title="Insert Number">
                                                {{number}}
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="insertFileVariable('email')" title="Insert Email">
                                                {{email}}
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="insertFileVariable('company')" title="Insert Company">
                                                {{company}}
                                            </button>
                                        </div>
                                        <div class="btn-group me-2" role="group" id="fileSpecificVariables">
                                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="insertFileVariable('fileName')" title="Insert File Name">
                                                {{fileName}}
                                            </button>
                                        </div>
                                        <div class="btn-group me-2" role="group" id="customFileVariables">
                                            <!-- Dynamic variables from imported headers will be added here -->
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="insertFileVariable('date')" title="Insert Date">
                                                {{date}}
                                            </button>
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="insertFileVariable('time')" title="Insert Time">
                                                {{time}}
                                            </button>
                                        </div>
                                    </div>

                                    <textarea class="form-control" id="blastFilesMessage" rows="6"
                                              placeholder="Type your message here...&#10;&#10;Use toolbar buttons or type: *bold*, _italic_, ~strikethrough~, \`\`\`monospace\`\`\`&#10;Use variables from your imported file headers" required></textarea>

                                    <!-- Live Preview -->
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleFilePreview()" id="filePreviewToggle">
                                            <i class="fas fa-eye me-1"></i>
                                            Show Preview
                                        </button>
                                    </div>

                                    <div id="fileMessagePreview" class="mt-2 p-3 border rounded bg-light" style="display: none;">
                                        <h6>Message Preview:</h6>
                                        <div id="filePreviewContent" class="preview-content"></div>
                                    </div>

                                    <div class="form-text">
                                        <strong>Available variables:</strong> <span id="availableFileVariables">{{name}}, {{number}}, {{email}}, {{company}}, {{fileName}}, {{date}}, {{time}}</span>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="fileBlastDelay" class="form-label">Delay Between Messages (ms)</label>
                                        <input type="number" class="form-control" id="fileBlastDelay" value="2000" min="1000" max="10000">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="fileBlastRetry" class="form-label">Retry Attempts</label>
                                        <input type="number" class="form-control" id="fileBlastRetry" value="2" min="1" max="5">
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Send Blast with Files
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Preview Modal -->
    <div class="modal fade" id="templatePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>
                        Template Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="templatePreviewContent">
                        <!-- Template previews will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="loadingText">Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="file-matching.js"></script>

    <!-- Auto-fix loading issue -->
    <script>
        // Force hide loading modal after page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loadingModal = document.getElementById('loadingModal');
                if (loadingModal) {
                    loadingModal.style.display = 'none';
                    loadingModal.classList.remove('show');
                }

                // Remove any modal backdrops
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                    backdrop.remove();
                });

                // Clean body classes
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';

                // Show blast form and toolbar
                const blastForm = document.getElementById('blastFilesForm');
                if (blastForm) {
                    blastForm.style.display = 'block';
                    blastForm.style.visibility = 'visible';
                    blastForm.style.opacity = '1';
                }

                // Force show toolbar
                const toolbar = document.querySelector('.btn-toolbar');
                if (toolbar) {
                    toolbar.style.display = 'flex';
                    toolbar.style.visibility = 'visible';
                    toolbar.style.opacity = '1';
                }

                // Force show all buttons
                document.querySelectorAll('.btn-toolbar .btn').forEach(btn => {
                    btn.style.display = 'inline-block';
                    btn.style.visibility = 'visible';
                    btn.style.opacity = '1';
                });
            }, 1000);
        });

        // Debug and force show toolbar
        setTimeout(() => {
            console.log('ðŸ”§ Debugging toolbar visibility...');

            const blastForm = document.getElementById('blastFilesForm');
            const toolbar = document.querySelector('.btn-toolbar');
            const blastTab = document.getElementById('blast-files-tab');

            console.log('Blast Form:', blastForm ? 'Found' : 'Not Found');
            console.log('Toolbar:', toolbar ? 'Found' : 'Not Found');
            console.log('Blast Tab:', blastTab ? 'Found' : 'Not Found');

            if (blastForm) {
                console.log('Form display:', getComputedStyle(blastForm).display);
                console.log('Form visibility:', getComputedStyle(blastForm).visibility);
            }

            if (toolbar) {
                console.log('Toolbar display:', getComputedStyle(toolbar).display);
                console.log('Toolbar visibility:', getComputedStyle(toolbar).visibility);

                // Force show toolbar
                toolbar.style.display = 'flex';
                toolbar.style.visibility = 'visible';
                toolbar.style.opacity = '1';
                toolbar.style.height = 'auto';
                toolbar.style.overflow = 'visible';

                console.log('âœ… Toolbar forced visible');
            }

            // Auto-click blast tab to ensure it's active
            if (blastTab && !blastTab.classList.contains('active')) {
                blastTab.click();
                console.log('âœ… Blast tab activated');
            }

            // Force activate blast tab and show content
            setTimeout(() => {
                // Activate blast tab
                const blastTab = document.getElementById('blast-files-tab');
                const blastContent = document.getElementById('blast-files');

                if (blastTab && blastContent) {
                    // Remove active from other tabs
                    document.querySelectorAll('.nav-link').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });

                    // Activate blast tab
                    blastTab.classList.add('active');
                    blastContent.classList.add('show', 'active');

                    console.log('âœ… Blast tab force activated');

                    // Force show toolbar after tab activation
                    setTimeout(() => {
                        const toolbar = document.querySelector('#blast-files .btn-toolbar');
                        const form = document.querySelector('#blast-files #blastFilesForm');

                        if (toolbar) {
                            toolbar.style.display = 'flex';
                            toolbar.style.visibility = 'visible';
                            toolbar.style.opacity = '1';
                            toolbar.style.height = 'auto';
                            console.log('âœ… Toolbar force shown');
                        }

                        if (form) {
                            form.style.display = 'block';
                            form.style.visibility = 'visible';
                            form.style.opacity = '1';
                            console.log('âœ… Form force shown');
                        }
                    }, 200);
                }
            }, 3000);

        }, 2000);

        // Function to manually activate blast tab
        window.activateBlastTab = function() {
            console.log('ðŸŽ¯ Manual activation of blast tab...');

            // Activate blast tab
            const blastTab = document.getElementById('blast-files-tab');
            const blastContent = document.getElementById('blast-files');

            if (blastTab && blastContent) {
                // Remove active from other tabs
                document.querySelectorAll('.nav-link').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });

                // Activate blast tab
                blastTab.classList.add('active');
                blastContent.classList.add('show', 'active');

                console.log('âœ… Blast tab manually activated');

                // Force show toolbar and form
                setTimeout(() => {
                    const toolbar = document.querySelector('#blast-files .btn-toolbar');
                    const form = document.querySelector('#blast-files #blastFilesForm');

                    if (toolbar) {
                        toolbar.style.display = 'flex';
                        toolbar.style.visibility = 'visible';
                        toolbar.style.opacity = '1';
                        toolbar.style.height = 'auto';
                        toolbar.style.overflow = 'visible';
                        console.log('âœ… Toolbar manually shown');
                    }

                    if (form) {
                        form.style.display = 'block';
                        form.style.visibility = 'visible';
                        form.style.opacity = '1';
                        console.log('âœ… Form manually shown');
                    }

                    // Scroll to the editor
                    const messageTextarea = document.getElementById('blastFilesMessage');
                    if (messageTextarea) {
                        messageTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        messageTextarea.focus();
                    }

                    alert('âœ… Rich Text Editor is now active! You can see the formatting toolbar above the message box.');
                }, 100);
            } else {
                alert('âŒ Could not find blast tab elements. Please refresh the page.');
            }
        };

        // Contact Search Functions
        let currentSearchTerm = '';

        function searchContacts() {
            const searchInput = document.getElementById('contactSearchInput');
            const searchInFilesOnly = document.getElementById('searchInFilesOnly');
            const searchResultsCount = document.getElementById('searchResultsCount');

            if (!searchInput || !window.originalMatchingResults) return;

            const searchTerm = searchInput.value.toLowerCase().trim();
            const filesOnlyFilter = searchInFilesOnly ? searchInFilesOnly.checked : false;
            currentSearchTerm = searchTerm;

            let filteredResults = [...window.originalMatchingResults];

            // Apply search filter
            if (searchTerm) {
                filteredResults = filteredResults.filter(item => {
                    const contact = item.contact;
                    const matchedFile = item.matchedFile;

                    // Search in contact fields
                    const nameMatch = (contact.name || '').toLowerCase().includes(searchTerm);
                    const numberMatch = (contact.number || '').toLowerCase().includes(searchTerm);
                    const emailMatch = (contact.email || '').toLowerCase().includes(searchTerm);
                    const companyMatch = (contact.company || '').toLowerCase().includes(searchTerm);

                    // Search in file fields
                    const fileNameMatch = (contact.fileName || '').toLowerCase().includes(searchTerm);
                    const matchedFileMatch = matchedFile ? (matchedFile.fileName || '').toLowerCase().includes(searchTerm) : false;

                    return nameMatch || numberMatch || emailMatch || companyMatch || fileNameMatch || matchedFileMatch;
                });
            }

            // Apply files-only filter
            if (filesOnlyFilter) {
                filteredResults = filteredResults.filter(item => item.matchedFile);
            }

            // Update search results count
            if (searchResultsCount) {
                const totalResults = window.originalMatchingResults.length;
                const filteredCount = filteredResults.length;

                if (searchTerm || filesOnlyFilter) {
                    searchResultsCount.textContent = `Showing ${filteredCount} of ${totalResults} contacts`;
                    searchResultsCount.className = filteredCount === 0 ? 'text-warning' : 'text-info';
                } else {
                    searchResultsCount.textContent = `${totalResults} contacts total`;
                    searchResultsCount.className = 'text-muted';
                }
            }

            // Re-render the filtered results
            displayFilteredMatchingResults(filteredResults);
        }

        function clearContactSearch() {
            const searchInput = document.getElementById('contactSearchInput');
            const searchInFilesOnly = document.getElementById('searchInFilesOnly');
            const searchResultsCount = document.getElementById('searchResultsCount');

            if (searchInput) searchInput.value = '';
            if (searchInFilesOnly) searchInFilesOnly.checked = false;
            if (searchResultsCount) {
                const totalResults = window.originalMatchingResults ? window.originalMatchingResults.length : 0;
                searchResultsCount.textContent = `${totalResults} contacts total`;
                searchResultsCount.className = 'text-muted';
            }

            currentSearchTerm = '';

            // Show all results
            if (window.originalMatchingResults) {
                displayFilteredMatchingResults(window.originalMatchingResults);
            }
        }

        function displayFilteredMatchingResults(results) {
            const matchingResults = document.getElementById('matchingResults');
            if (!matchingResults) return;

            if (results.length === 0) {
                matchingResults.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-search me-2"></i>
                        No contacts found matching your search criteria.
                        <button class="btn btn-sm btn-outline-warning ms-2" onclick="clearContactSearch()">
                            <i class="fas fa-times me-1"></i>Clear Search
                        </button>
                    </div>
                `;
                return;
            }

            // Generate statistics for filtered results
            const matchedCount = results.filter(item => item.matchedFile).length;
            const unmatchedCount = results.length - matchedCount;

            const statsHtml = `
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h4>${results.length}</h4>
                                <small>Total Contacts</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4>${matchedCount}</h4>
                                <small>Matched</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h4>${unmatchedCount}</h4>
                                <small>Unmatched</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h4>${Math.round((matchedCount / results.length) * 100)}%</h4>
                                <small>Match Rate</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Contact Name</th>
                                <th>Number</th>
                                <th>Email</th>
                                <th>Company</th>
                                <th>Expected File</th>
                                <th>Matched File</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(item => {
                                const contact = item.contact;
                                const matchedFile = item.matchedFile;
                                const searchTerm = currentSearchTerm;

                                // Highlight search terms
                                const highlightText = (text, term) => {
                                    if (!term || !text) return text || '-';
                                    const regex = new RegExp(`(${term})`, 'gi');
                                    return text.replace(regex, '<mark>$1</mark>');
                                };

                                return `
                                    <tr>
                                        <td>${highlightText(contact.name, searchTerm)}</td>
                                        <td><span class="badge bg-secondary">${highlightText(contact.number, searchTerm)}</span></td>
                                        <td>${highlightText(contact.email, searchTerm)}</td>
                                        <td>${highlightText(contact.company, searchTerm)}</td>
                                        <td><code>${highlightText(contact.fileName || 'Not specified', searchTerm)}</code></td>
                                        <td>
                                            ${matchedFile ?
                                                `<span class="badge bg-success">${highlightText(matchedFile.fileName, searchTerm)}</span>` :
                                                '<span class="text-muted">No match</span>'
                                            }
                                        </td>
                                        <td>
                                            ${matchedFile ?
                                                '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Matched</span>' :
                                                '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>No File</span>'
                                            }
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            matchingResults.innerHTML = statsHtml + tableHtml;
        }
    </script>
</body>
</html>
