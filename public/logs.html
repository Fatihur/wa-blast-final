<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Logs - WA Blast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Dynamic Navbar Container -->
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list-alt me-2"></i>
                            Message Logs
                        </h5>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshLogs()">
                                <i class="fas fa-sync-alt me-1"></i>
                                Refresh
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="clearLogs()">
                                <i class="fas fa-trash me-1"></i>
                                Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filter Controls -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="success">Success</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="typeFilter">
                                    <option value="">All Types</option>
                                    <option value="text">Text</option>
                                    <option value="image">Image</option>
                                    <option value="document">Document</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="numberFilter" placeholder="Filter by number...">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="applyFilters()">
                                    <i class="fas fa-filter me-1"></i>
                                    Filter
                                </button>
                            </div>
                        </div>

                        <!-- Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4 id="totalCount">0</h4>
                                        <small>Total Messages</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 id="successCount">0</h4>
                                        <small>Successful</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h4 id="failedCount">0</h4>
                                        <small>Failed</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 id="successRate">0%</h4>
                                        <small>Success Rate</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Logs Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Time</th>
                                        <th>Number</th>
                                        <th>Type</th>
                                        <th>Message</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Loading logs...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Logs pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Dynamic Navbar Scripts -->
    <script src="navbar.js"></script>
    <script src="navbar-config.js"></script>
    <script>
        let allLogs = [];
        let filteredLogs = [];
        let currentPage = 1;
        const logsPerPage = 20;

        // Load logs on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadLogs();
            
            // Auto refresh every 30 seconds
            setInterval(loadLogs, 30000);
        });

        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                if (data.success) {
                    allLogs = data.logs;
                    filteredLogs = [...allLogs];
                    updateStatistics();
                    displayLogs();
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                showError('Failed to load logs');
            }
        }

        function updateStatistics() {
            const total = filteredLogs.length;
            const successful = filteredLogs.filter(log => log.status === 'success').length;
            const failed = filteredLogs.filter(log => log.status === 'failed').length;
            const successRate = total > 0 ? Math.round((successful / total) * 100) : 0;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('successCount').textContent = successful;
            document.getElementById('failedCount').textContent = failed;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        function displayLogs() {
            const tbody = document.getElementById('logsTableBody');
            const startIndex = (currentPage - 1) * logsPerPage;
            const endIndex = startIndex + logsPerPage;
            const pageData = filteredLogs.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-inbox me-2"></i>
                            No logs found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pageData.map(log => `
                <tr>
                    <td>
                        <small>${formatDateTime(log.timestamp)}</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${log.number}</span>
                    </td>
                    <td>
                        <span class="badge bg-${getTypeBadgeColor(log.type)}">${log.type}</span>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${log.message}">
                            ${log.message}
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${log.status === 'success' ? 'success' : 'danger'}">
                            <i class="fas fa-${log.status === 'success' ? 'check' : 'times'} me-1"></i>
                            ${log.status}
                        </span>
                    </td>
                    <td>
                        ${log.messageId ? `<small>ID: ${log.messageId}</small>` : ''}
                        ${log.error ? `<small class="text-danger">${log.error}</small>` : ''}
                        ${log.attempts ? `<small class="text-info">Attempts: ${log.attempts}</small>` : ''}
                    </td>
                </tr>
            `).join('');

            updatePagination();
        }

        function getTypeBadgeColor(type) {
            switch(type) {
                case 'text': return 'primary';
                case 'image': return 'success';
                case 'document': return 'warning';
                default: return 'secondary';
            }
        }

        function formatDateTime(timestamp) {
            return new Date(timestamp).toLocaleString('id-ID');
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayLogs();
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const numberFilter = document.getElementById('numberFilter').value.toLowerCase();

            filteredLogs = allLogs.filter(log => {
                const matchStatus = !statusFilter || log.status === statusFilter;
                const matchType = !typeFilter || log.type === typeFilter;
                const matchNumber = !numberFilter || log.number.toLowerCase().includes(numberFilter);
                
                return matchStatus && matchType && matchNumber;
            });

            currentPage = 1;
            updateStatistics();
            displayLogs();
        }

        function refreshLogs() {
            loadLogs();
        }

        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs?')) {
                return;
            }

            try {
                const response = await fetch('/api/logs', {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    allLogs = [];
                    filteredLogs = [];
                    updateStatistics();
                    displayLogs();
                    showSuccess('Logs cleared successfully');
                } else {
                    showError('Failed to clear logs');
                }
            } catch (error) {
                console.error('Error clearing logs:', error);
                showError('Failed to clear logs');
            }
        }

        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function showError(message) {
            showAlert(message, 'danger');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
