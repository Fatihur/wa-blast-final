<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Assignment Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
        }
        .log-output {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 1rem;
            border-radius: 0.375rem;
            height: 300px;
            overflow-y: auto;
        }
        .step-indicator {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
        }
        .step-indicator.active {
            background: #007bff;
        }
        .step-indicator.success {
            background: #28a745;
        }
        .step-indicator.error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-cogs me-2"></i>Manual Assignment Test Suite</h1>
        <p class="text-muted">Test the complete manual assignment flow to verify file assignment mismatch fixes</p>

        <!-- Test Progress -->
        <div class="test-section">
            <h5>Test Progress</h5>
            <div class="d-flex align-items-center mb-3">
                <span class="step-indicator" id="step1">1</span>
                <span>Manual Assignment</span>
            </div>
            <div class="d-flex align-items-center mb-3">
                <span class="step-indicator" id="step2">2</span>
                <span>File Validation</span>
            </div>
            <div class="d-flex align-items-center mb-3">
                <span class="step-indicator" id="step3">3</span>
                <span>Preview Verification</span>
            </div>
            <div class="d-flex align-items-center mb-3">
                <span class="step-indicator" id="step4">4</span>
                <span>Send Process Simulation</span>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="test-section">
            <h5>Test Controls</h5>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-primary mb-2" onclick="runFullTest()">
                        <i class="fas fa-play me-2"></i>Run Full Test
                    </button><br>
                    <button class="btn btn-success mb-2" onclick="testManualAssignment()">
                        <i class="fas fa-file me-2"></i>Test Manual Assignment
                    </button><br>
                    <button class="btn btn-info mb-2" onclick="testValidation()">
                        <i class="fas fa-check me-2"></i>Test Validation
                    </button><br>
                    <button class="btn btn-warning mb-2" onclick="testPreview()">
                        <i class="fas fa-eye me-2"></i>Test Preview
                    </button><br>
                    <button class="btn btn-secondary mb-2" onclick="clearLog()">
                        <i class="fas fa-trash me-2"></i>Clear Log
                    </button>
                </div>
                <div class="col-md-6">
                    <h6>Test Configuration</h6>
                    <div class="mb-2">
                        <label class="form-label">Test Contact Name:</label>
                        <input type="text" class="form-control" id="testContactName" value="Test Contact">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Test File Name:</label>
                        <select class="form-select" id="testFileName">
                            <option value="">Select a file...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-section">
            <h5>Test Log</h5>
            <div id="testLog" class="log-output">
                <div>Manual Assignment Test Suite Ready...</div>
                <div>Click "Run Full Test" to start comprehensive testing</div>
            </div>
        </div>

        <!-- Test Data Display -->
        <div class="test-section">
            <h5>Test Data</h5>
            <div class="row">
                <div class="col-md-4">
                    <h6>Manual Assignments</h6>
                    <pre id="manualAssignments" class="bg-light p-2" style="font-size: 12px; height: 200px; overflow-y: auto;">Loading...</pre>
                </div>
                <div class="col-md-4">
                    <h6>Validation Results</h6>
                    <pre id="validationResults" class="bg-light p-2" style="font-size: 12px; height: 200px; overflow-y: auto;">No validation data</pre>
                </div>
                <div class="col-md-4">
                    <h6>Preview Data</h6>
                    <pre id="previewData" class="bg-light p-2" style="font-size: 12px; height: 200px; overflow-y: auto;">No preview data</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="modal-cleanup.js"></script>
    <script>
        let testData = {
            manualAssignments: {},
            validationResults: {},
            previewData: {},
            availableFiles: []
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd43b' : '#00ff00';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStepIndicator(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `step-indicator ${status}`;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '<div>Log cleared...</div>';
        }

        async function loadAvailableFiles() {
            try {
                log('Loading available files...');
                const response = await fetch('/api/file-matching/documents');
                const data = await response.json();
                
                if (data.success) {
                    testData.availableFiles = data.files;
                    const select = document.getElementById('testFileName');
                    select.innerHTML = '<option value="">Select a file...</option>';
                    
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.fileName;
                        option.textContent = file.fileName;
                        select.appendChild(option);
                    });
                    
                    log(`âœ… Loaded ${data.files.length} files`, 'success');
                } else {
                    log(`âŒ Failed to load files: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`âŒ Error loading files: ${error.message}`, 'error');
            }
        }

        async function testManualAssignment() {
            try {
                updateStepIndicator('step1', 'active');
                log('ðŸ”„ Testing manual assignment...');
                
                const contactName = document.getElementById('testContactName').value;
                const fileName = document.getElementById('testFileName').value;
                
                if (!contactName || !fileName) {
                    log('âŒ Please enter contact name and select a file', 'error');
                    updateStepIndicator('step1', 'error');
                    return false;
                }
                
                const response = await fetch('/api/file-matching/manual-assignment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        contactName: contactName,
                        fileName: fileName,
                        assignmentType: 'test'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    testData.manualAssignments[contactName] = data.assignmentData;
                    updateDataDisplay('manualAssignments', testData.manualAssignments);
                    log(`âœ… Manual assignment successful: ${contactName} -> ${fileName}`, 'success');
                    updateStepIndicator('step1', 'success');
                    return true;
                } else {
                    log(`âŒ Manual assignment failed: ${data.error}`, 'error');
                    updateStepIndicator('step1', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Manual assignment error: ${error.message}`, 'error');
                updateStepIndicator('step1', 'error');
                return false;
            }
        }

        async function testValidation() {
            try {
                updateStepIndicator('step2', 'active');
                log('ðŸ”„ Testing validation process...');
                
                // Simulate validation by checking if assigned file exists
                const contactName = document.getElementById('testContactName').value;
                const assignment = testData.manualAssignments[contactName];
                
                if (!assignment) {
                    log('âŒ No manual assignment found for validation', 'error');
                    updateStepIndicator('step2', 'error');
                    return false;
                }
                
                const fileExists = testData.availableFiles.some(f => f.fileName === assignment.fileName);
                
                if (fileExists) {
                    log(`âœ… Validation passed: File ${assignment.fileName} exists`, 'success');
                    updateStepIndicator('step2', 'success');
                    return true;
                } else {
                    log(`âŒ Validation failed: File ${assignment.fileName} not found`, 'error');
                    updateStepIndicator('step2', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Validation error: ${error.message}`, 'error');
                updateStepIndicator('step2', 'error');
                return false;
            }
        }

        async function testPreview() {
            try {
                updateStepIndicator('step3', 'active');
                log('ðŸ”„ Testing preview data...');
                
                const response = await fetch('/api/file-matching/enhanced-preview');
                const data = await response.json();
                
                if (data.success) {
                    testData.previewData = data;
                    updateDataDisplay('previewData', data.preview);
                    
                    const contactName = document.getElementById('testContactName').value;
                    const contactPreview = data.preview.find(p => 
                        (p.contact.name || p.contact.nama) === contactName
                    );
                    
                    if (contactPreview) {
                        const expectedFile = testData.manualAssignments[contactName]?.fileName;
                        const actualFile = contactPreview.matchedFile?.fileName;
                        
                        if (expectedFile === actualFile) {
                            log(`âœ… Preview verification passed: ${contactName} -> ${actualFile}`, 'success');
                            updateStepIndicator('step3', 'success');
                            return true;
                        } else {
                            log(`âŒ Preview mismatch: Expected ${expectedFile}, got ${actualFile}`, 'error');
                            updateStepIndicator('step3', 'error');
                            return false;
                        }
                    } else {
                        log(`âŒ Contact not found in preview: ${contactName}`, 'error');
                        updateStepIndicator('step3', 'error');
                        return false;
                    }
                } else {
                    log(`âŒ Preview failed: ${data.error}`, 'error');
                    updateStepIndicator('step3', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Preview error: ${error.message}`, 'error');
                updateStepIndicator('step3', 'error');
                return false;
            }
        }

        async function runFullTest() {
            log('ðŸš€ Starting full test suite...', 'info');
            
            // Reset indicators
            ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                updateStepIndicator(id, '');
            });
            
            // Run tests in sequence
            const step1 = await testManualAssignment();
            if (!step1) return;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const step2 = await testValidation();
            if (!step2) return;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const step3 = await testPreview();
            if (!step3) return;
            
            updateStepIndicator('step4', 'success');
            log('ðŸŽ‰ Full test suite completed successfully!', 'success');
        }

        function updateDataDisplay(elementId, data) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAvailableFiles();
            log('âœ… Test suite initialized', 'success');
        });
    </script>
</body>
</html>
